generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AdminRole {
  SUPER_ADMIN
  EDITOR
}

enum AdminStatus { 
  ACTIVE
  SUSPENDED
}

enum OAuthProvider {
  GOOGLE
  GITHUB
}

enum SiteRole {
  OWNER
  EDITOR
  VIEWER
}

enum ApiTokenRole {
  READ_ONLY
  READ_WRITE
}

enum SiteStatus {
  ACTIVE
  SUSPENDED
}

enum DomainStatus {
  PENDING
  VERIFIED
  FAILED
}

enum PostStatus {
  DRAFT
  PUBLISHED
}

enum Plan {
  FREE
  STARTER
  GROWTH
  PRO
  ENTERPRISE
}

model AdminUser {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String?
  role         AdminRole @default(EDITOR)
  status       AdminStatus @default(ACTIVE)
  avatarUrl    String?
  oauthProvider OAuthProvider?
  oauthSubject  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  resetToken    String?
  resetExpires  DateTime?

  posts        BlogPost[]
  memberships  AdminSiteMembership[]
  primarySiteId String?
  primarySite   Site?    @relation("PrimarySite", fields: [primarySiteId], references: [id])
  accountSubscription AccountSubscription?
  serpAnalyses SerpAnalysis[]

  @@unique([oauthProvider, oauthSubject])
}

model BlogPost {
  id            String     @id @default(cuid())
  siteId        String
  site          Site       @relation(fields: [siteId], references: [id])
  title         String
  slug          String
  excerpt       String?
  coverImageUrl String?
  contentHtml   String
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?
  imageGenCount Int        @default(0)
  primaryKeyword    String?
  secondaryKeywords String[] @default([])
  metaTitle         String?
  metaDescription   String?
  serpAnalysisId    String?
  serpAnalysis      SerpAnalysis? @relation(fields: [serpAnalysisId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  seoScore          Int        @default(0)

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  authorId      String
  author        AdminUser  @relation(fields: [authorId], references: [id])

  tags          BlogPostTag[]

  @@unique([siteId, slug])
}

model Tag {
  id        String   @id @default(cuid())
  siteId    String
  site      Site     @relation(fields: [siteId], references: [id])
  name      String
  slug      String
  createdAt DateTime @default(now())

  posts     BlogPostTag[]

  @@unique([siteId, slug])
  @@unique([siteId, name])
}

model BlogPostTag {
  postId String
  tagId  String

  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
}

model Site {
  id             String                 @id @default(cuid())
  name           String
  slug           String                 @unique
  domains        String[]
  status         SiteStatus             @default(ACTIVE)
  defaultLocale  String?
  settingsJson   Json?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  posts          BlogPost[]
  tags           Tag[]
  memberships    AdminSiteMembership[]
  apiTokens      ApiToken[]
  siteDomains    SiteDomain[]
  primaryFor     AdminUser[]            @relation("PrimarySite")
  serpAnalyses   SerpAnalysis[]
}

model AccountSubscription {
  id          String   @id @default(cuid())
  adminId     String   @unique
  admin       AdminUser @relation(fields: [adminId], references: [id])
  plan        Plan     @default(FREE)
  status      String   @default("active")
  startedAt   DateTime @default(now())
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Subscription {
  id          String   @id @default(cuid())
  siteId      String   @unique
  plan        Plan     @default(FREE)
  status      String   @default("active")
  startedAt   DateTime @default(now())
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AdminSiteMembership {
  id        String   @id @default(cuid())
  adminId   String
  siteId    String
  role      SiteRole @default(EDITOR)
  createdAt DateTime @default(now())

  admin     AdminUser @relation(fields: [adminId], references: [id])
  site      Site      @relation(fields: [siteId], references: [id])

  @@unique([adminId, siteId])
}

model ApiToken {
  id         String       @id @default(cuid())
  siteId     String
  name       String
  hashed     String
  plain      String @default("")
  role       ApiTokenRole @default(READ_ONLY)
  expiresAt  DateTime?
  lastUsedAt DateTime?
  createdAt  DateTime     @default(now())

  site       Site @relation(fields: [siteId], references: [id])
}

model SerpAnalysis {
  id           String    @id @default(cuid())
  siteId       String
  site         Site      @relation(fields: [siteId], references: [id])
  createdById  String?
  createdBy    AdminUser? @relation(fields: [createdById], references: [id])
  keyword      String
  location     String
  language     String
  competitors  Json
  benchmarks   Json
  nlpTerms     Json
  createdAt    DateTime  @default(now())
  expiresAt    DateTime
  blogPosts    BlogPost[]

  @@index([siteId, keyword, location, language])
  @@index([expiresAt])
}

model SiteDomain {
  id                 String        @id @default(cuid())
  siteId             String
  domain             String
  verificationToken  String
  status             DomainStatus  @default(PENDING)
  verifiedAt         DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  site               Site          @relation(fields: [siteId], references: [id])

  @@unique([siteId, domain])
}
